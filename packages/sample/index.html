<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Test page</title>
		<link href="./src/style.css" rel="stylesheet" />
	</head>
	<body>
		<div id="video-container">
			<div id="ranger">
				<input type="range" min="0" max="7646" value="0" step="0.25" />
				<div id="timers">
					<span id="currentTime">0</span>
					<span id="durationTime">7646</span>
				</div>
			</div>
			<captions-presenter id="presenter"></captions-presenter>
		</div>
		<button id="playback-btn" data-paused="false">PAUSE</button>
		<script type="module">
			import "@hsubs/captions-presenter-web";
			import { HSServer } from "@hsubs/server";
			import { WebVTTRenderer } from "@hsubs/webvtt-renderer";
			import { FakeHTMLVideoElement } from "./src/FakeHTMLVideoElement";
			import longTextTrackVTTPath from "./src/longtexttrack.vtt";

			/**
			 * @type {HSServer}
			 */

			const server = new HSServer(WebVTTRenderer);
			const ranger = document.querySelector("#ranger input");
			const currentTime = document.getElementById("currentTime");
			const videoTag = new FakeHTMLVideoElement(parseFloat(ranger.getAttribute("max")));

			videoTag.addEventListener("timeupdate", (time) => {
				ranger.value = time;
				currentTime.innerText = time;
			});

			ranger.addEventListener("input", () => {
				const time = parseFloat(ranger.value);
				videoTag.currentTime = time;

				ranger.value = time;
				currentTime.innerText = time;

				if (server.isRunning) {
					return;
				}

				server.updateTime(time * 1000);
			});

			const playbackBtn = document.getElementById("playback-btn");

			playbackBtn.addEventListener("click", (e) => {
				if (videoTag.paused) {
					videoTag.play();
					e.currentTarget.textContent = "Pause";
				} else {
					e.currentTarget.textContent = "Resume";
					videoTag.pause();
				}
			});

			// server.createSession(
			// 	[
			// 		{
			// 			lang: "it",
			// 			content: `
			// WEBVTT

			// 00:00:00.000 --> 00:00:02.000 region:fred align:left
			// <v Fred>Hi, my name is Fred

			// 00:00:02.500 --> 00:00:04.500 region:bill align:right
			// <v Bill>Hi, I’m Bill

			// 00:00:05.000 --> 00:00:06.000 region:fred align:left
			// <v Fred>Would you like to get a coffee?

			// 00:00:07.500 --> 00:00:09.500 region:bill align:right
			// <v Bill>Sure! I’ve only had one today.

			// 00:00:10.000 --> 00:00:11.000 region:fred align:left
			// <v Fred>This is my fourth!

			// 00:00:12.500 --> 00:00:13.500 region:fred align:left
			// <v Fred>OK, let’s go.
			// `,
			// 		},
			// 	],
			// 	"text/vtt",
			// );

			server.addEventListener("cueerror", (error) => {
				console.warn(error);
			});

			// 			WEBVTT

			// REGION
			// id:fred
			// width:40%
			// lines:3
			// align:center
			// regionanchor:0%,100%
			// viewportanchor:10%,90%
			// scroll:up

			// REGION
			// id:bill
			// align:right
			// width:40%
			// lines:3
			// regionanchor:0%,100%
			// viewportanchor:10%,90%
			// scroll:up

			// 00:00:00.000 --> 00:10:00.000 region:fred align:left
			// Hello world.

			// 00:00:03.000 --> 00:10:00.000 region:bill align:right
			// Hello milady ;)

			// 00:00:04.000 --> 00:10:00.000 region:fred align:left
			// Hello world, bibi

			fetch(longTextTrackVTTPath)
				.then((e) => e.text())
				.then((data) => {
					const timeStart = performance.now();

					server.createSession(
						[
							{
								lang: "it",
								content: data,
							},
						],
						"text/vtt",
					);
					console.info(
						`%c[DEBUG] Track parsing took: ${performance.now() - timeStart}ms`,
						"background-color: #af0000; color: #FFF; padding: 5px; margin: 5px",
					);

					videoTag.addEventListener("playing", () => {
						if (server.isRunning) {
							server.resume();
							return;
						}

						server.start(() => {
							return parseFloat(ranger.value) * 1000;
						});
					});

					videoTag.addEventListener("pause", () => {
						server.suspend();
					});
				});

			const presenter = document.getElementById("presenter");

			server.addEventListener("cuestart", (cues) => {
				const timeStart = performance.now();
				// console.log("CUE START:", cues);
				presenter.setCue(cues);
				console.info(
					`%c[DEBUG] Cue rendering took: ${performance.now() - timeStart}ms`,
					"background-color: #7900ff; color: #FFF; padding: 5px; margin: 5px",
					cues,
				);
			});
			server.addEventListener("cuestop", () => {
				console.log("CUES STOP");
				presenter.setCue();
			});

			videoTag.play();

			setTimeout(() => {
				server.addTextChunk(
					`
			WEBVTT

			1192
			01:35:20.440 --> 01:35:23.040
			&lt;i&gt;La scoperta è stata fatta&lt;/i&gt;
			&lt;i&gt;dalla Swat dell'FBI&lt;/i&gt;

			1193
			01:35:23.120 --> 01:35:24.600
			&lt;i&gt;che ha fatto irruzione nel complesso.&lt;/i&gt;

			1194
			01:35:24.680 --> 01:35:27.240
			&lt;i&gt;Il dispositivo che inizialmente&lt;/i&gt;
			&lt;i&gt;si credeva fosse una bomba,&lt;/i&gt;

			1195
			01:35:27.320 --> 01:35:30.760
			&lt;i&gt;si è rivelato essere un server esca,&lt;/i&gt;
			&lt;i&gt;messo lì dai colpevoli,&lt;/i&gt;

			1196
			01:35:30.840 --> 01:35:33.040
			&lt;i&gt;solo per depistare le autorità.&lt;/i&gt;

			1197
			01:35:33.120 --> 01:35:36.400
			&lt;i&gt;Al momento, non ci sono ancora&lt;/i&gt;
			&lt;i&gt;sospettati per questo caso&lt;/i&gt;.

			1198
			01:35:36.480 --> 01:35:38.200
			&lt;i&gt;Bentornati al Chuck Torn Show.&lt;/i&gt;

			1199
			01:35:38.280 --> 01:35:40.920
			&lt;i&gt;Ho parlato con il gigante della tecnologia&lt;/i&gt;
			&lt;i&gt;Nero Alexander,&lt;/i&gt;

			1200
			01:35:41.000 --> 01:35:42.560
			&lt;i&gt;proprietario di più di 70 aziende,&lt;/i&gt;

			1201
			01:35:42.640 --> 01:35:46.120
			&lt;i&gt;che spaziano dalla bio-costruzione,&lt;/i&gt;
			&lt;i&gt;ai carburanti, alla farmaceutica,&lt;/i&gt;

			1202
			01:35:46.200 --> 01:35:48.680
			&lt;i&gt;alle intelligenze artificiali&lt;/i&gt;
			&lt;i&gt;e ora anche alla nanotecnologia.&lt;/i&gt;

			1203
			01:35:48.760 --> 01:35:51.880
			&lt;i&gt;Nero, hai realizzato&lt;/i&gt;
			&lt;i&gt;quello che pochi altri hanno raggiunto,&lt;/i&gt;

			1204
			01:35:51.960 --> 01:35:54.880
			&lt;i&gt;hai costruito un impero&lt;/i&gt;
			&lt;i&gt;senza l'aiuto di nessuno.&lt;/i&gt;

			1205
			01:35:54.960 --> 01:35:57.920
			&lt;i&gt;Non hai ereditato alcuna ricchezza,&lt;/i&gt;
			&lt;i&gt;eppure, a un certo punto,&lt;/i&gt;

			1206
			01:35:58.000 --> 01:36:02.080
			sei diventato il più giovane miliardario
			del pianeta. Non è così?

			1207
			01:36:02.160 --> 01:36:06.200
			Sono quasi in pensione adesso,
			mi voglio solo divertire.

			1208
			01:36:06.880 --> 01:36:08.680
			A tutti gli imprenditori in erba

			1209
			01:36:08.760 --> 01:36:12.920
			che ti considerano un esempio di quello
			che è possibile ottenere, che cosa dici?

			1210
			01:36:13.000 --> 01:36:17.080
			So soltanto che la gran parte dei giovani
			di oggi vuole tutto, senza fare niente.

			1211
			01:36:17.160 --> 01:36:20.120
			Vuole fama e fortuna con
			il minimo sforzo possibile.

			1212
			01:36:21.000 --> 01:36:26.200
			È lo scienziato il modello da seguire,
			il fisico, l'ingegnere, l'inventore.

			1213
			01:36:26.880 --> 01:36:30.360
			Non qualcuno il cui unico contributo
			all'umanità è un video porno

			1214
			01:36:31.040 --> 01:36:35.760
			o uno stupido reality show
			o milioni di followers sui social.

			1215
			01:36:35.840 --> 01:36:37.720
			Insomma, è una vera follia!

			1216
			01:36:40.320 --> 01:36:45.360
			Quindi credo di dover dire: fate qualcosa
			che dia un contributo alla società,

			1217
			01:36:45.440 --> 01:36:46.920
			io so di averlo fatto.

			1218
			01:37:24.720 --> 01:37:26.240
			Cat Zim.

			1219
			01:37:28.520 --> 01:37:32.080
			Sei una donna piena di sorprese,
			non è vero?

			1220
			01:37:49.200 --> 01:37:51.920
			Allora, ti sei divertita?

			1221
			01:37:54.480 --> 01:37:55.480
			Sì.

			1222
			01:37:56.320 --> 01:37:57.520
			Ma la prossima volta...

			1223
			01:37:58.720 --> 01:38:00.560
			non ti lascerò vincere a scacchi.

			1224
			01:41:12.280 --> 01:41:13.680
			Si, è Gary che parla.

			1225
			01:41:14.840 --> 01:41:18.600
			Nevin? No, sta partecipando
			a uno show, &lt;i&gt;Funhouse&lt;/i&gt;, mi sembra.

			1226
			01:41:19.560 --> 01:41:20.560
			Cosa?

			1227
			01:41:21.280 --> 01:41:22.280
			È morto?

			1228
			01:41:23.720 --> 01:41:25.080
			Pignatta umana?

			1229
			01:41:25.960 --> 01:41:27.160
			Che cazzata è questa?

			1230
			01:41:30.000 --> 01:41:31.880
			Abbiamo avuto lo stesso i 100.000?

			1231
			01:41:34.800 --> 01:41:37.960
			Che mi prenda un colpo.
			Posso avere un altro Mai Tai?
								`,
					"it",
				);
			}, 3000);
		</script>
	</body>
</html>
