<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Test page</title>
		<link href="./src/style.css" rel="stylesheet" />
	</head>
	<body>
		<div id="video-container">
			<div id="ranger">
				<input type="range" min="0" max="7646" value="0" step="0.25" />
				<div id="timers">
					<span id="currentTime">0</span>
					<span id="durationTime">7646</span>
				</div>
			</div>
			<captions-presenter id="presenter"></captions-presenter>
		</div>
		<button id="playback-btn" data-paused="false">PAUSE</button>
		<script type="module">
			import "@hsubs/captions-presenter-web";
			import { HSServer } from "@hsubs/server";
			import { WebVTTRenderer } from "@hsubs/webvtt-renderer";
			import { FakeHTMLVideoElement } from "./src/FakeHTMLVideoElement";
			import longTextTrackVTTPath from "./src/longtexttrack.vtt";
			import longTextTrackVTTPathChunk from "./src/longtexttrack-chunk1.vtt";

			/**
			 * @type {HSServer}
			 */

			const server = new HSServer(WebVTTRenderer);
			const ranger = document.querySelector("#ranger input");
			const currentTime = document.getElementById("currentTime");
			const videoTag = new FakeHTMLVideoElement(parseFloat(ranger.getAttribute("max")));

			document.addEventListener("keyup", ({ code }) => {
				switch (code) {
					case "ArrowLeft": {
						videoTag.currentTime = videoTag.currentTime - 10;
						break;
					}
					case "ArrowRight": {
						videoTag.currentTime = videoTag.currentTime + 10;
						break;
					}
					case "Space": {
						if (videoTag.paused) {
							videoTag.play();
						} else {
							videoTag.pause();
						}
					}
				}
			});

			videoTag.addEventListener("timeupdate", (time) => {
				ranger.value = time;
				currentTime.innerText = time;
			});

			ranger.addEventListener("input", () => {
				const time = parseFloat(ranger.value);
				videoTag.currentTime = time;

				ranger.value = time;
				currentTime.innerText = time;

				if (server.isRunning) {
					return;
				}

				server.updateTime(time * 1000);
			});

			const playbackBtn = document.getElementById("playback-btn");

			playbackBtn.addEventListener("click", (e) => {
				if (videoTag.paused) {
					videoTag.play();
					e.currentTarget.textContent = "Pause";
				} else {
					e.currentTarget.textContent = "Resume";
					videoTag.pause();
				}
			});

			// server.createSession(
			// 	[
			// 		{
			// 			lang: "it",
			// 			content: `
			// WEBVTT

			// 00:00:00.000 --> 00:00:02.000 region:fred align:left
			// <v Fred>Hi, my name is Fred

			// 00:00:02.500 --> 00:00:04.500 region:bill align:right
			// <v Bill>Hi, I’m Bill

			// 00:00:05.000 --> 00:00:06.000 region:fred align:left
			// <v Fred>Would you like to get a coffee?

			// 00:00:07.500 --> 00:00:09.500 region:bill align:right
			// <v Bill>Sure! I’ve only had one today.

			// 00:00:10.000 --> 00:00:11.000 region:fred align:left
			// <v Fred>This is my fourth!

			// 00:00:12.500 --> 00:00:13.500 region:fred align:left
			// <v Fred>OK, let’s go.
			// `,
			// 		},
			// 	],
			// 	"text/vtt",
			// );

			server.addEventListener("cueerror", (error) => {
				console.warn(error);
			});

			// 			WEBVTT

			// REGION
			// id:fred
			// width:40%
			// lines:3
			// align:center
			// regionanchor:0%,100%
			// viewportanchor:10%,90%
			// scroll:up

			// REGION
			// id:bill
			// align:right
			// width:40%
			// lines:3
			// regionanchor:0%,100%
			// viewportanchor:10%,90%
			// scroll:up

			// 00:00:00.000 --> 00:10:00.000 region:fred align:left
			// Hello world.

			// 00:00:03.000 --> 00:10:00.000 region:bill align:right
			// Hello milady ;)

			// 00:00:04.000 --> 00:10:00.000 region:fred align:left
			// Hello world, bibi

			const [vttTrack, vttChunk] = await Promise.all([
				fetch(longTextTrackVTTPath).then((e) => e.text()),
				fetch(longTextTrackVTTPathChunk).then((e) => e.text()),
			]);

			const timeStart = performance.now();

			server.createSession(
				[
					{
						lang: "it",
						content: vttTrack,
					},
				],
				"text/vtt",
			);
			console.info(
				`%c[DEBUG] Track parsing took: ${performance.now() - timeStart}ms`,
				"background-color: #af0000; color: #FFF; padding: 5px; margin: 5px",
			);

			videoTag.addEventListener("playing", () => {
				if (server.isRunning) {
					server.resume();
					return;
				}

				server.start(() => {
					return parseFloat(ranger.value) * 1000;
				});
			});

			videoTag.addEventListener("pause", () => {
				server.suspend();
			});

			const presenter = document.getElementById("presenter");

			server.addEventListener("cuestart", (cues) => {
				const timeStart = performance.now();
				// console.log("CUE START:", cues);
				presenter.setCue(cues);
				console.info(
					`%c[DEBUG] Cue rendering took: ${performance.now() - timeStart}ms`,
					"background-color: #7900ff; color: #FFF; padding: 5px; margin: 5px",
					cues,
				);
			});
			server.addEventListener("cuestop", () => {
				console.log("CUES STOP");
				presenter.setCue();
			});

			videoTag.play();

			setTimeout(() => {
				server.addTextChunk(vttChunk, "it");
			}, 3000);
		</script>
	</body>
</html>
